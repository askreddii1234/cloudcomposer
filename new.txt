from flask import Flask, request, jsonify, render_template_string
import pandas as pd
import re
import os
from datetime import datetime, timedelta
from google.cloud import storage
import logging

app = Flask(__name__)

# Environment-specific configurations
PROJECTS = {
    'bld': {
        'project_id': 'extractly-421810',
        'bucket_name': 'extractly-421810',
        'target_bucket': 'audiosmith'  # Static target bucket for BLD environment
    },
    # Add other environments as needed...
}

def list_blobs(project_id, bucket_name, prefix):
    client = storage.Client(project=project_id)
    bucket = client.bucket(bucket_name)
    return bucket.list_blobs(prefix=prefix)

@app.route('/generate_dashboard/<source_type>/<env>', methods=['GET'])
def generate_dashboard(source_type, env):
    try:
        # Retrieve start_date and end_date from query parameters
        start_date_str = request.args.get('start_date')
        end_date_str = request.args.get('end_date', start_date_str)

        if not start_date_str:
            return jsonify({'error': 'Please provide a start_date query parameter.'}), 400

        start_date = datetime.strptime(start_date_str, '%d-%m-%Y')
        end_date = datetime.strptime(end_date_str, '%d-%m-%Y')

        today = datetime.now()
        if start_date > today or end_date > today:
            return jsonify({'error': 'Date cannot be in the future.'}), 400

        if (end_date - start_date).days > 30:
            return jsonify({'error': 'Date range should not exceed 30 days.'}), 400

        if (today - start_date).days > 30:
            return jsonify({'error': 'Date should be within the last 30 days from today.'}), 400

        env_config = PROJECTS.get(env)
        if not env_config:
            return jsonify({'error': 'Invalid environment specified.'}), 400

        target_bucket = env_config['target_bucket']

        if source_type == 'fmo':
            static_file = 'static_table_list_fmo.csv'
            prefix = 'EXTERNAL/MFVS/SOLIFI/BDM/FMO/'
            pattern = r'EXTERNAL/MFVS/SOLIFI/BDM/FMO/(?P<table>TRANSPORT-DATA-FMO_[^/]+)/RECEIVED/(?P<date>\d{4}-\d{2}-\d{2})/(?P<file_name>.+)'
        elif source_type == 'cms':
            static_file = 'static_table_list_cms.csv'
            prefix = 'EXTERNAL/MFVS/SOLIFI/BDM/CMS/'
            pattern = r'EXTERNAL/MFVS/SOLIFI/BDM/CMS/(?P<table>TRANSPORT-DATA-CMS_[^/]+)/RECEIVED/(?P<date>\d{4}-\d{2}-\d{2})/(?P<file_name>.+)'

        static_table_list = pd.read_csv(static_file)
        all_tables = set(static_table_list['Table Name'])

        # List blobs from GCS
        blobs = list_blobs(env_config['project_id'], env_config['bucket_name'], prefix)

        if not blobs:
            return jsonify({'error': 'No data available for the specified date range.'}), 404

        # Adjust the date range to ensure there's always at least one column in the DataFrame
        date_range = pd.date_range(start=start_date, end=end_date)
        if len(date_range) == 1:
            date_range = pd.date_range(start=start_date, periods=1)

        status_last_5_days = pd.DataFrame(index=static_table_list['Table Name'], columns=date_range, data=0)

        file_pattern = re.compile(pattern)
        
        for blob in blobs:
            logging.debug(f"Processing blob: {blob.name}")
            match = file_pattern.match(blob.name)
            if match:
                logging.debug(f"Blob matched: {blob.name}")
                table_name = match.group('table').replace("TRANSPORT-DATA-FMO_", "").replace("TRANSPORT-DATA-CMS_", "").strip()
                date_received = datetime.strptime(match.group('date'), '%Y-%m-%d')
                
                if table_name in status_last_5_days.index:
                    if start_date <= date_received <= end_date:
                        status_last_5_days.at[table_name, date_received] += 1
                else:
                    logging.debug(f"Table name {table_name} not found in static list.")
            else:
                logging.error(f"Regex did not match for blob: {blob.name}")

        # Save the dashboard report to a CSV file
        dashboard_report_path = f'/tmp/{source_type}_dashboard_report_{datetime.now().strftime("%Y%m%d%H%M%S")}.csv'
        status_last_5_days.to_csv(dashboard_report_path, index=True)

        # Upload the dashboard report to the specified GCS bucket
        dashboard_gcs_path = f'dashboards/{source_type}/{os.path.basename(dashboard_report_path)}'
        #upload_to_gcs(target_bucket, dashboard_report_path, dashboard_gcs_path)

        # Convert the DataFrame for found tables to an HTML table with styling
        found_table_html = (
            status_last_5_days.style
            .applymap(lambda x: 'background-color: lightgreen' if x > 0 else 'background-color: lightcoral', subset=pd.IndexSlice[:, :])
            .set_table_attributes('class="table table-hover table-bordered table-responsive-sm"')
            .set_properties(**{'text-align': 'center'})
            .to_html()
        )

        # Render the HTML tables using Flask's render_template_string
        return render_template_string("""
            <html>
                <head>
                    <title>{{ source_type.upper() }} Data Dashboard</title>
                    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
                    <style>
                        body {
                            background-color: #f0f0f0;
                        }
                        h2 {
                            margin-top: 20px;
                            margin-bottom: 20px;
                            color: #333;
                        }
                        .table-container {
                            margin-top: 30px;
                        }
                        .table-responsive {
                            background-color: white;
                            padding: 20px;
                            border-radius: 5px;
                            box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.1);
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <h2>{{ source_type.upper() }} Data Dashboard -: {{ env.upper() }} ({{ start_date_str }} to {{ end_date_str }})</h2>
                        <div class="table-container">
                            <h3>Table Data Counts</h3>
                            <div class="table-responsive">
                                {{ found_table_html | safe }}
                            </div>
                        </div>
                    </div>
                </body>
            </html>
        """, source_type=source_type, env=env, start_date_str=start_date_str, end_date_str=end_date_str, found_table_html=found_table_html)

    except ValueError as e:
        return jsonify({'error': f'Date format error: {str(e)}. Please ensure the dates are in DD-MM-YYYY format.'}), 400
    except Exception as e:
        return jsonify({'error': f'Error: {str(e)}'}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080, debug=True)
